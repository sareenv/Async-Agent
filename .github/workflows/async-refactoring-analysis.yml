name: Async/Await Refactoring Analysis

on:
  pull_request:
    branches:
      - develop
      - main
    paths:
      - '**/*.swift'
      - '.github/workflows/async-refactoring-analysis.yml'
  push:
    branches:
      - develop
      - main
    paths:
      - '**/*.swift'
      - '.github/workflows/async-refactoring-analysis.yml'

jobs:
  async-refactoring-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write  # For commenting on PRs
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comparison
      
      - name: Get changed Swift files
        id: changed-files
        run: |
          set -euo pipefail
          
          echo "Finding changed Swift files..."
          
          # Determine the base branch for comparison
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_REF="${{ github.event.pull_request.base.ref }}"
            git fetch origin $BASE_REF
            COMPARE_REF="origin/$BASE_REF"
          else
            # For push events, compare with previous commit
            # Check if HEAD~1 exists (won't exist on first commit)
            if git rev-parse HEAD~1 >/dev/null 2>&1; then
              COMPARE_REF="HEAD~1"
            else
              # First commit - analyze all Swift files
              echo "First commit detected, analyzing all Swift files"
              COMPARE_REF=""
            fi
          fi
          
          # Get changed Swift files
          if [ -z "$COMPARE_REF" ]; then
            # First commit - get all Swift files
            CHANGED_FILES=$(find . -name '*.swift' -type f | grep -v '.build/' || true)
          else
            CHANGED_FILES=$(git diff --name-only --diff-filter=ACMRT $COMPARE_REF HEAD | grep '\.swift$' || true)
          fi
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No Swift files changed."
            echo "has_swift_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Save to file
          echo "$CHANGED_FILES" > changed_files.txt
          
          # Display what we found
          echo "Changed Swift files:"
          cat changed_files.txt
          
          # Count files
          FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l)
          echo "Total changed Swift files: $FILE_COUNT"
          echo "has_swift_changes=true" >> $GITHUB_OUTPUT
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
      
      - name: Upload changed files list
        if: steps.changed-files.outputs.has_swift_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: changed-files-list
          path: changed_files.txt
          retention-days: 30
      
      # NOTE: GitHub Copilot CLI automation is not currently available in GitHub Actions
      # This section would need to be implemented using:
      # - GitHub Copilot Workspace API (when available)
      # - Custom analysis scripts
      # - Third-party AI/LLM services with appropriate API keys
      
      - name: Run Async/Await Analysis
        if: steps.changed-files.outputs.has_swift_changes == 'true'
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Running Async/Await Refactoring Analysis"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Verify agent file exists
          if [ ! -f ".github/agents/completionchecker.agent.md" ]; then
            echo "âŒ Error: Agent configuration file not found"
            exit 1
          fi
          
          # Create reports directory
          mkdir -p async-refactoring-reports
          
          # Read the file list
          FILES_TO_ANALYZE=$(cat changed_files.txt)
          
          echo "Files to analyze:"
          echo "$FILES_TO_ANALYZE"
          echo ""
          
          # Basic pattern detection for completion handlers and continuations
          echo "Performing basic async/await pattern detection..."
          echo ""
          
          REPORT_FILE="async-refactoring-reports/analysis-report.md"
          echo "# Async/Await Refactoring Analysis" > "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "**Repository:** $GITHUB_REPOSITORY" >> "$REPORT_FILE"
          echo "**Event:** ${{ github.event_name }}" >> "$REPORT_FILE"
          echo "**Branch:** ${{ github.ref_name }}" >> "$REPORT_FILE"
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "## Files Analyzed" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "\`\`\`" >> "$REPORT_FILE"
          echo "$FILES_TO_ANALYZE" >> "$REPORT_FILE"
          echo "\`\`\`" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "## Pattern Detection Results" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          
          HIGH_PRIORITY_FOUND=false
          
          # Analyze each file for patterns
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "Analyzing: $file"
              
              # Check for completion handlers
              COMPLETION_COUNT=$(grep -c "completion:" "$file" 2>/dev/null || echo "0")
              # Check for @escaping closures
              ESCAPING_COUNT=$(grep -c "@escaping" "$file" 2>/dev/null || echo "0")
              # Check for continuations
              CONTINUATION_COUNT=$(grep -c "withCheckedContinuation\|withUnsafeContinuation" "$file" 2>/dev/null || echo "0")
              
              if [ "$COMPLETION_COUNT" -gt 0 ] || [ "$ESCAPING_COUNT" -gt 0 ] || [ "$CONTINUATION_COUNT" -gt 0 ]; then
                echo "### \`$file\`" >> "$REPORT_FILE"
                echo "" >> "$REPORT_FILE"
                
                if [ "$COMPLETION_COUNT" -gt 0 ]; then
                  echo "- **Completion handlers found:** $COMPLETION_COUNT" >> "$REPORT_FILE"
                  HIGH_PRIORITY_FOUND=true
                fi
                
                if [ "$ESCAPING_COUNT" -gt 0 ]; then
                  echo "- **@escaping closures found:** $ESCAPING_COUNT" >> "$REPORT_FILE"
                fi
                
                if [ "$CONTINUATION_COUNT" -gt 0 ]; then
                  echo "- **Continuations found:** $CONTINUATION_COUNT" >> "$REPORT_FILE"
                fi
                
                echo "" >> "$REPORT_FILE"
              fi
            fi
          done < changed_files.txt
          
          echo "" >> "$REPORT_FILE"
          echo "## Recommendations" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          
          if [ "$HIGH_PRIORITY_FOUND" = true ]; then
            echo "âš ï¸  Completion handlers detected" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "Consider refactoring completion handler-based code to use async/await:" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "1. Replace completion handlers with async functions" >> "$REPORT_FILE"
            echo "2. Use \`await\` instead of completion callbacks" >> "$REPORT_FILE"
            echo "3. Leverage structured concurrency (Task, async let)" >> "$REPORT_FILE"
            echo "4. Replace \`@escaping\` with async/await patterns" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "HIGH PRIORITY ASYNC REFACTORING REQUIRED" >> "$REPORT_FILE"
          else
            echo "âœ… No completion handlers detected in changed files." >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "The analyzed files appear to follow modern Swift concurrency patterns." >> "$REPORT_FILE"
          fi
          
          echo ""
          echo "âœ… Analysis complete"
          cat "$REPORT_FILE"
      
      - name: Upload analysis report
        if: always() && steps.changed-files.outputs.has_swift_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: async-refactoring-report-${{ github.run_id }}
          path: async-refactoring-reports/
          retention-days: 30
      
      - name: Check for high priority refactoring opportunities
        if: always() && steps.changed-files.outputs.has_swift_changes == 'true'
        id: check-priority
        run: |
          set -euo pipefail
          
          REPORT_PATH="async-refactoring-reports/analysis-report.md"
          
          if [ ! -f "$REPORT_PATH" ]; then
            echo "âš ï¸  No analysis report found. Copilot may not have generated it."
            echo "has_high_priority=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Checking for high priority refactoring opportunities..."
          
          # Check for the kill switch message
          if grep -q "HIGH PRIORITY ASYNC REFACTORING REQUIRED" "$REPORT_PATH"; then
            echo "ğŸ”´ HIGH PRIORITY refactoring opportunities detected!"
            echo "has_high_priority=true" >> $GITHUB_OUTPUT
            
            # Extract summary for display
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Summary of High Priority Items:"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            cat "$REPORT_PATH" | head -50
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          else
            echo "âœ… No high priority refactoring required, or only Low/Medium priority items found."
            echo "has_high_priority=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Comment on PR with analysis
        if: |
          always() && 
          github.event_name == 'pull_request' && 
          steps.changed-files.outputs.has_swift_changes == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const reportPath = 'async-refactoring-reports/analysis-report.md';
            
            let comment = '## ğŸ” Async/Await Refactoring Analysis\n\n';
            
            if (!fs.existsSync(reportPath)) {
              comment += 'âš ï¸ Analysis report was not generated. Please check the workflow logs.\n';
            } else {
              const report = fs.readFileSync(reportPath, 'utf8');
              const hasHighPriority = report.includes('HIGH PRIORITY ASYNC REFACTORING REQUIRED');
              
              if (hasHighPriority) {
                comment += 'ğŸ”´ **High Priority Refactoring Opportunities Found**\n\n';
                comment += 'This PR introduces code with completion handlers or continuations that should be refactored to async/await.\n\n';
              } else {
                comment += 'âœ… No high priority refactoring required.\n\n';
              }
              
              comment += '<details>\n<summary>ğŸ“‹ View Full Analysis Report</summary>\n\n';
              comment += report;
              comment += '\n</details>\n\n';
              comment += '---\n';
              comment += `ğŸ“¦ [Download full report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n`;
            }
            
            // Post the comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
      
      - name: Optional - Fail on high priority items
        if: |
          always() && 
          steps.check-priority.outputs.has_high_priority == 'true' &&
          github.event_name == 'pull_request'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš ï¸  HIGH PRIORITY ASYNC REFACTORING REQUIRED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "This PR introduces completion handlers or continuations that"
          echo "should be refactored to async/await patterns."
          echo ""
          echo "Please review the analysis report and address high-priority items."
          echo ""
          echo "To view the report:"
          echo "1. Check the workflow artifacts"
          echo "2. Review the PR comment with full analysis"
          echo ""
          echo "If this is intentional, you can:"
          echo "1. Document why the pattern is necessary"
          echo "2. Request review from a senior developer"
          echo "3. Override this check (not recommended)"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Comment this out to make the check informational only
          # Uncomment to enforce blocking on high priority items
          # exit 1
